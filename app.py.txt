import os
import datetime
import random
from flask import Flask, request, jsonify
from flask_cors import CORS

app = Flask(__name__)
# Enable Cross-Origin Resource Sharing so your phone can talk to this server
CORS(app)

# CONFIGURATION
# In a real app, use environment variables for secrets. 
# For this test, we hardcode the token.
AEGIS_API_KEY = "papi-secure-token-2025-v2"
user_shopping_cart = []

# SECURITY MIDDLEWARE
def aegis_guard(func):
    def wrapper(*args, **kwargs):
        api_key = request.headers.get('X-Aegis-Token')
        if api_key != AEGIS_API_KEY:
            return jsonify({
                "status": "error", 
                "message": "ACCESS DENIED: AegisCore Security Protocol Violation."
            }), 403
        return func(*args, **kwargs)
    wrapper.__name__ = func.__name__
    return wrapper

# UTILITY: Generate a fake realistic price
def get_factual_price(item_name):
    return round(random.uniform(10.0, 50.0), 2)

# ROUTE: Home (Health Check)
@app.route('/')
def home():
    return "ðŸ§  PAPI Backend is Online & Secure. Ready for requests."

# ROUTE: Secure Shop (Add Item)
@app.route('/api/secure-shop', methods=['POST'])
@aegis_guard
def add_to_cart():
    data = request.json
    item = data.get('item')
    if not item: return jsonify({"message": "No item provided"}), 400

    price = get_factual_price(item)
    entry = {
        "item": item,
        "price_estimate": price,
        "added_at": datetime.datetime.now().isoformat()
    }
    user_shopping_cart.append(entry)

    return jsonify({
        "status": "success",
        "data": entry,
        "papi_comment": f"I've found '{item}' for approx ${price}. Added to your secure list.",
        "legal_disclaimer": "PAPI assumes no financial liability for price fluctuations.",
        "aegis_verification": "Session Encrypted (AES-256)"
    }), 200

# ROUTE: View Cart
@app.route('/api/view-cart', methods=['GET'])
@aegis_guard
def view_cart():
    return jsonify({"cart": user_shopping_cart, "total_items": len(user_shopping_cart)})

if __name__ == '__main__':
    # CRITICAL FOR RENDER: Use the PORT environment variable
    port = int(os.environ.get('PORT', 10000))
    app.run(host='0.0.0.0', port=port)